# AVR Multi Motor Control -- Paolo Lucchesi
# Makefile for client-side program
.POSIX:
.SUFFIXES: # Reset all implicit rules
.PRECIOUS: $(OBJDIR)/%.o # Keep objects when generated as intermediate targets

# Codebase directory structure
SRCDIR := source
INCDIR := include
OBJDIR := objects
RESDIR := resources
TGTDIR := target

# Search Paths
vpath %.c $(SRCDIR)
vpath %.s $(SRCDIR)

# Compiler setup
CC := gcc
CFLAGS := -std=gnu99 -Wall -I$(INCDIR) -funsigned-bitfields -fshort-enums -Wno-missing-braces
NDEBUGFLAGS := -O2 -DNDEBUG
DEBUGFLAGS := -O2 -ggdb -DDEBUG

ifndef DEBUG
  CFLAGS += $(NDEBUGFLAGS)
else
  CFLAGS += $(DEBUGFLAGS)
endif

# Object files to be generated by GNU Make (e.g. foobar.o)
# Do not prefix the object directory (e.g. foo.o is OK, objects/foo.o is not)
OBJECTS = $(patsubst $(SRCDIR)/%.c, $(OBJDIR)/%.o, $(wildcard $(SRCDIR)/*.c))
TARGET := $(TGTDIR)/ammc


# Objects and binaries recipes

$(OBJDIR)/%.o:	%.c
	$(CC) $(CFLAGS) -c -o $@ $<

$(OBJDIR)/%.o:	%.s
	$(AS) $(ASFLAGS) -c -o $@ $<


$(TARGET): $(OBJECTS)
	$(CC) $(CFLAGS) -o $@ $^

all: $(TARGET);

install:
	install -m 0755 $(TGTDIR)/ammc /usr/bin/ammc
	strip /usr/bin/ammc

install-docs:
	install -m 0644 $(RESDIR)/man/ammc.1.gz /usr/share/man/man1/

docs: $(RESDIR)/man/ammc.1.gz ;

$(RESDIR)/man/%.gz: $(RESDIR)/man/%.md
	pandoc --standalone --to man $< | gzip --stdout - > $@

clean:
	rm -f $(OBJDIR)/*.o $(TGTDIR)/*


.PHONY:	clean all install docs install-docs
